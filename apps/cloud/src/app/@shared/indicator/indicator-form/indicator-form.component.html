<div class="w-full flex flex-wrap justify-between items-center p-4">
  <h2 class="px-2 text-xl font-semibold text-text-primary">
    {{ 'PAC.INDICATOR.EditIndicator' | translate: {Default: "Edit Indicator"} }}
  </h2>

  <div class="flex items-center gap-2 ml-auto">
    <div class="inline-flex items-center gap-1 system-xs-semibold-uppercase">
      @switch (status()) {
        @case (eIndicatorStatusEnum.DRAFT) {
          <div class="w-2 h-2 mr-1 border border-solid rounded-[3px] bg-orange-500 border-orange-700 shadow-[0_0_5px_-3px_rgba(249,112,102,0.1),0.5px_0.5px_3px_rgba(249, 112, 102, 0.2), inset_1.5px_1.5px_0_rgba(255, 255, 255, 0.4)]"></div>
          <span class="">{{ 'PAC.INDICATOR.Draft' | translate: {Default: 'Draft'} }}</span>
        }
        @case (eIndicatorStatusEnum.RELEASED) {
          <span class='w-2 h-2 mr-1 rounded-[2.5px] shadow-md bg-emerald-500 flex'></span>
          <span >{{ 'PAC.INDICATOR.Published' | translate: {Default: 'Published'} }}</span>
        }
        @case (eIndicatorStatusEnum.ARCHIVED) {
          <span class='w-2 h-2 mr-1 rounded-[2.5px] shadow-md bg-neutral-600 flex'></span>
          <span >({{ 'PAC.INDICATOR.Archived' | translate: {Default: 'Archived'} }})</span>
        }
        @default {
          <span class="text-neutral-500">({{ 'PAC.INDICATOR.Unknown' | translate: {Default: 'Unknown'} }})</span>
        }
      }
    </div>
     <button type="button" class="btn pressable relative flex justify-center items-center w-7 h-7 rounded-lg border-0 text-text-secondary hover:text-text-primary
        bg-transparent hover:bg-hover-bg"
      [cdkMenuTriggerFor]="checklistMenu">
      <i class="ri-list-check-3"></i>
      @if (checklist()?.length) {
        <div class="absolute -right-1.5 -top-1.5 flex h-[18px] min-w-[18px] items-center justify-center rounded-full border border-gray-100 bg-[#F79009] text-[11px] font-semibold text-white">
          {{checklist()?.length ?? 0}}</div>
      }
    </button>
    <button type="button" class="btn disabled:btn-disabled btn-primary btn-medium relative"
      [disabled]="!isDirty() || register_form.formGroup.invalid || saving()"
      (click)="onSave()"
    >
      <i class="ri-save-line mr-1"></i>
      {{ 'PAC.ACTIONS.Save' | translate: {Default: "Save"} }}
      @if (isDirty()) {
        <span class="absolute top-1 end-1 inline-flex items-center transform -translate-y-1/2 translate-x-1/2">
          @if (saving()) {
            <i class="ri-loader-line text-xs animate-spin"></i>
          } @else {
            <span class="w-3 h-3 rounded-full border-2 border-white text-xs font-medium bg-text-warning text-white dark:border-neutral-900">
              <span class="sr-only">Is dirty</span>
            </span>
          }
        </span>
      }
    </button>

    <button class="btn btn-secondary w-8 h-8 flex justify-center items-center rounded-lg"
      [cdkMenuTriggerFor]="menu"
      #mt="cdkMenuTriggerFor"
      [class.active]="mt.isOpen()"
    >
      <i class="ri-more-2-line"></i>
    </button>
  </div>
</div>

<div #content class="flex-1 overflow-x-hidden overflow-y-auto p-2">
  <xp-indicator-register-form #register_form
    [certifications]="certifications()"
    [models]="models()"
    [(ngModel)]="draftForm"
  />
    
  @if (loading()) {
    <ngm-spin class="absolute top-0 left-0 w-full h-full"></ngm-spin>
  }

  <div class="w-full max-w-full flex flex-col items-center">
    <button mat-flat-button (click)="togglePreview()">
      <mat-icon fontSet="material-icons-round">{{ preview() ? 'expand_less' : 'expand_more' }}</mat-icon>
      <span>
        {{ 'PAC.INDICATOR.DataPreview' | translate: {Default: 'Data Preview'} }}
      </span>
    </button>
    
    @if (preview()) {
      @if (error()) {
        <div class="w-full h-[300px] flex justify-center items-center">
          <span class="">{{ error() }}</span>
        </div>
      } @else {
        <ngm-analytical-card class="w-full h-[300px]"
          [dataSettings]="dataSettings()"
          [chartOptions]="chartOptions()"
          [chartSettings]="chartSettings()"
          [options]="{
            realtimeLinked: true,
          }"
          (explain)="setExplains($event)"
          >
          <div class="flex-1 flex items-center">
            <span class="text-base font-medium ml-4 whitespace-nowrap">{{ 'PAC.INDICATOR.Period' | translate: {Default: 'Period'} }}</span>

            @for (p of PERIODS; track p.name) {
              <span class="pac-indicator__period-tag text-sm cursor-pointer inline-flex items-center font-semibold leading-sm uppercase px-2 py-1 rounded-lg"
                [ngClass]="{selected: p.name === previewPeriod()}"
                (click)="togglePeriod(p.name)"
              >
                {{p.name}}
              </span>
            }
          </div>

          <div ngmAction>
            <button class="btn pressable flex justify-center items-center w-6 h-6 rounded-full border-light" (click)="openExplain()">
              <i class="ri-terminal-box-line"></i>
            </button>
          </div>
        </ngm-analytical-card>
      }
    }
  </div>
</div>

@if (!indicator()) {
  <div class="absolute top-0 left-0 h-full w-full flex flex-col justify-center items-center flex-1 z-10 bg-white/5 backdrop-blur-sm">
    <div class="pac-result">
      <div class="bug font-notoColorEmoji">üêû</div>
      <div class="description text-text-secondary">
        {{ 'PAC.INDICATOR.IndicatorNotFound' | translate: {Default: 'Indicator not found'} }}: {{id()}}
      </div>
    </div>
  </div>
}

<ng-template #menu>
  <div cdkMenu class="cdk-menu__medium">
    <button cdkMenuItem class="disabled:text-text-tertiary" (click)="openProject()">
      <i class="ri-external-link-line mr-1"></i>
      {{ 'PAC.INDICATOR.OpenProject' | translate: {Default: "Open Project"} }}
    </button>
    <button cdkMenuItem class="disabled:text-text-tertiary" [disabled]="!indicator()?.draft" (click)="publish()">
      <i class="ri-send-plane-line mr-1"></i>
      {{ 'PAC.INDICATOR.Publish' | translate: {Default: "Publish"} }}
    </button>
    <button cdkMenuItem class="disabled:text-text-tertiary" (click)="downloadTempl()" >
      <i class="ri-download-2-line mr-1"></i>
      {{ 'PAC.INDICATOR.MY_INDICATORS.EXPORT' | translate: {Default: "Export"} }}
    </button>

    <button cdkMenuItem class="disabled:text-text-tertiary danger" (click)="delete()">
      <i class="ri-delete-bin-line mr-1"></i>
      {{ 'PAC.INDICATOR.Delete' | translate: {Default: "Delete"} }}
    </button>
  </div>
</ng-template>

<ng-template #checklistMenu>
  <xp-checklist cdkMenu class="cdk-menu__large rounded-xl" [checklist]="checklist()" />
</ng-template>