<xpert-webapp class="w-full h-full overflow-y-auto" >
  @if (!xpert()) {
    <pac-chat-xperts class="w-full @lg:w-4/5 max-w-[50rem] overflow-x-auto no-touch-scrollbar" />
  }

  <button action class="inline-flex items-center justify-center gap-2 max-w-[160px] whitespace-nowrap text-base font-medium leading-[normal] truncate cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:opacity-50 disabled:cursor-default text-primary
    hover:bg-hover-bg rounded-xl px-3.5 py-2 flex-row pl-3 pr-2.5 h-9 sm:px-3 border border-button-outline-border sm:border-0
    text-text-secondary hover:text-text-primary"
    type="button"
    [attr.active]="cmt.isOpen()"
    #cmt="cdkMenuTriggerFor"
    [cdkMenuTriggerFor]="menu"
  >
    @if (xpert()) {
      <div class="truncate">{{xpert()?.title || xpert()?.name}}</div>
    } @else {
      <div class="truncate">{{ 'PAC.Chat.Common' | translate: {Default: 'Common'} }}</div>
    }
    <i class="ri-arrow-down-s-line transition-transform text-text-secondary" [class.rotate-180]="cmt.isOpen()"></i>
  </button>
</xpert-webapp>


<ng-template #menu>
  <div cdkMenu class="cdk-menu__large max-w-sm text-text-primary overflow-visible">
    <button class="flex justify-start items-center p-2 rounded-lg shadow-sm hover:shadow-md !bg-components-card-bg hover:!bg-neutral-50 sticky top-0 z-10"
      cdkMenuItem (click)="newConv()">
      <svg
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        stroke-width="2"
        class="mr-1"
      >
        <path
          d="M10 4V4C8.13623 4 7.20435 4 6.46927 4.30448C5.48915 4.71046 4.71046 5.48915 4.30448 6.46927C4 7.20435 4 8.13623 4 10V13.6C4 15.8402 4 16.9603 4.43597 17.816C4.81947 18.5686 5.43139 19.1805 6.18404 19.564C7.03968 20 8.15979 20 10.4 20H14C15.8638 20 16.7956 20 17.5307 19.6955C18.5108 19.2895 19.2895 18.5108 19.6955 17.5307C20 16.7956 20 15.8638 20 14V14"
          stroke="currentColor"
          stroke-linecap="square"
        ></path>
        <path
          d="M12.4393 14.5607L19.5 7.5C20.3284 6.67157 20.3284 5.32843 19.5 4.5C18.6716 3.67157 17.3284 3.67157 16.5 4.5L9.43934 11.5607C9.15804 11.842 9 12.2235 9 12.6213V15H11.3787C11.7765 15 12.158 14.842 12.4393 14.5607Z"
          stroke="currentColor"
          stroke-linecap="square"
        ></path>
      </svg>
      {{'PAC.Xpert.NewChat'  | translate: {Default: 'New Chat'} }}
    </button>

    <!-- Search digital experts -->
    <div class="bg-components-card-bg border-b border-border px-2 py-2 mb-2 relative overflow-visible" (click)="$event.stopPropagation()">
      <div class="relative">
        <input
          [placeholder]="('PAC.Chat.SearchXpert' | translate: {Default: '搜索数字专家'}) + '...'"
          class="w-full px-3 py-2 bg-components-input-bg-normal border border-components-input-border rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-primary"
          type="text"
          [formControl]="searchControl"
          (focus)="showXpertDropdown.set(true)"
          (blur)="onSearchBlur()"
        />
        @if (searchingXperts()) {
          <div class="absolute right-2 top-1/2 -translate-y-1/2">
            <ngm-spin small />
          </div>
        }
      </div>

      <!-- Search results dropdown -->
      @if (searchControl.value) {
        <div class="absolute top-full left-0 right-0 mt-1 bg-components-card-bg border border-border rounded-lg shadow-lg z-[100] max-h-[400px] min-h-[120px] overflow-y-auto">
          @if (searchingXperts()) {
            <div class="p-4 text-center text-text-secondary">
              <ngm-spin small />
            </div>
          } @else if (matchedXperts().length > 0) {
            <div class="py-1">
              @for (xpert of matchedXperts(); track xpert.id) {
                <div
                  class="px-4 py-2 hover:bg-button-ghost-hover cursor-pointer flex items-center gap-2"
                  (mousedown)="selectXpert(xpert)"
                >
                  <emoji-avatar [avatar]="xpert.avatar" xs class="shrink-0 rounded-lg overflow-hidden shadow-sm" />
                  <div class="flex-1 min-w-0">
                    <div class="font-medium text-text-primary truncate">{{ xpert.title || xpert.name }}</div>
                    @if (xpert.description) {
                      <div class="text-xs text-text-secondary truncate">{{ xpert.description }}</div>
                    }
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="p-4 text-center text-text-secondary">
              {{ 'PAC.Chat.NoXpertFound' | translate: {Default: '未找到匹配的智能专家'} }}
            </div>
          }
        </div>
      }
    </div>

    <!-- Published agents list -->
    @if (filteredXperts().length > 0) {
      @for (item of filteredXperts(); track item.id) {
        <button class="ngm-cdk-menu-item p-1" cdkMenuItem (click)="newXpertConv(item)">
          <emoji-avatar [avatar]="item.avatar" xs class="shrink-0 rounded-lg overflow-hidden shadow-sm mr-1" />
          <p class="overflow-hidden whitespace-nowrap text-ellipsis">{{item.title || item.name}}</p>
        </button>
      }
    }

    <!-- Empty state when no published agents -->
    @if (hasNoPublishedXperts()) {
      <div class="px-4 py-6 text-center">
        <div class="flex flex-col items-center gap-3">
          <i class="ri-robot-line text-4xl text-text-tertiary"></i>
          <div class="text-sm text-text-secondary max-w-xs">
            {{ 'PAC.Chat.NoPublishedXpert' | translate: {Default: '没有已发布的智能体，请在工作空间创建并点击"发布"发布智能管家'} }}
          </div>
          <a
            routerLink="/xpert/w"
            class="text-sm text-primary hover:underline flex items-center gap-1"
            (click)="$event.stopPropagation()"
          >
            {{ 'PAC.Chat.GotoWorkspace' | translate: {Default: '前往工作空间'} }}
            <i class="ri-arrow-right-line"></i>
          </a>
        </div>
      </div>
    }

    <!--
    <label class="px-2 pb-2">{{'PAC.KEY_WORDS.Knowledgebases' | translate: {Default: 'Knowledgebases'} }}</label>
    <div class="max-h-64 w-56 overflow-y-auto" (click)="$event.stopPropagation()">
      @if (knowledgebaseList()?.length) {
        <pac-knowledgebase-list class="w-full" [disabled]="disabled()" [knowledgebaseList]="knowledgebaseList()" [(knowledgebases)]="knowledgebases" />
      } @else {
        <div class="flex justify-center p-4 text-token-text-secondary">
          <i class="ri-battery-line mr-1"></i>
          {{ 'PAC.KEY_WORDS.Empty' | translate: {Default: 'Empty'} }}
        </div>
      }
    </div>

    @if (xpert()?.id) {
      <button class="ngm-cdk-menu-item p-1" cdkMenuItem (click)="openAbout()">
        <i class="ri-information-2-line mr-2"></i>
        {{'PAC.KEY_WORDS.About'  | translate: {Default: 'About'} }}
      </button>
    } -->
  </div>
</ng-template>
