<div class="flex justify-between items-center gap-2 px-4">
  <div class="grow flex justify-start items-center gap-2">
    <ngm-select class="w-40" [placeholder]="statusPlaceholder()" [selectOptions]="statusOptions()" [(ngModel)]="status" />
    <ngm-select class="w-40" [placeholder]="databasePlaceholder()" [selectOptions]="databases$ | async" [(ngModel)]="dataSourceId" />
  </div>
  
  <div class="flex space-x-2">
    <button type="button" class="btn disabled:btn-disabled btn-primary btn-medium"
      (click)="addTable()">
      <i class="ri-add-line mr-1"></i>
      <div>{{ 'PAC.Workspace.NewTable' | translate: {Default: 'New Table'} }}</div>
    </button>
    <div class="relative">
      <button type="button" class="btn disabled:btn-disabled btn-secondary btn-medium w-8 p-0"
        [cdkMenuTriggerFor]="moreMenu"
      >
        <i class="ri-more-line"></i>
      </button>
    </div>
  </div>
</div>

<div class="flex-1 overflow-x-auto px-4 mt-4">
  <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">{{ 'PAC.Workspace.TableName' | translate: {Default: 'Table Name'} }}</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">{{ 'PAC.KEY_WORDS.Description' | translate: {Default: 'Description'} }}</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">{{ 'PAC.KEY_WORDS.Status' | translate: {Default: 'Status'} }}</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">{{ 'PAC.KEY_WORDS.Version' | translate: {Default: 'Version'} }}</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">{{ 'PAC.Workspace.ActivatedAt' | translate: {Default: 'Activated At'} }}</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">{{ 'PAC.KEY_WORDS.Message' | translate: {Default: 'Message'} }}</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">{{ 'PAC.KEY_WORDS.Actions' | translate: {Default: 'Actions'} }}</th>
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      @for (table of tables(); track table.id) {
        <tr>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">{{ table.name }}</td>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ table.description || '-' }}</td>
          <td class="px-4 py-2 whitespace-nowrap text-sm">
            <span class="px-2 py-1 rounded-full text-xs font-semibold"
              [ngClass]="{
                'bg-green-100 text-green-800': table.status === eXpertTableStatus.ACTIVE,
                'bg-yellow-100 text-yellow-800': table.status === eXpertTableStatus.PENDING_ACTIVATION,
                'bg-red-100 text-red-800': table.status === eXpertTableStatus.DEPRECATED
              }">
              {{ table.status }}
            </span>
          </td>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ table.version || '-' }}</td>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ table.activatedAt ? (table.activatedAt | date:'yyyy-MM-dd HH:mm') : '-' }}</td>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ table.message }}</td>
          <!-- <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ table.xpertId }}</td> -->
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
            <div class="flex gap-1">
              <!-- ÊøÄÊ¥ªÊåâÈíÆÈöêËóè / Activate button hidden -->
              <button class="btn btn-ghost w-6 h-6 flex justify-center items-center rounded-lg" type="button"
                (click)="activate(table.id)"
                [title]="'PAC.Workspace.ActivateTable' | translate: {Default: 'Activate Table'}"
                hidden>
                <i class="ri-magic-line"></i>
              </button>

              <button class="btn btn-ghost w-6 h-6 flex justify-center items-center rounded-lg" type="button"
                (click)="editTable(table)"
                [title]="'PAC.Workspace.EditTable' | translate: {Default: 'Edit Table'}">
                <i class="ri-edit-line"></i>
              </button>

              <button class="btn btn-ghost w-6 h-6 flex justify-center items-center rounded-lg text-red-500 hover:bg-red-50" type="button"
                (click)="deleteTable(table)"
                [title]="'PAC.Workspace.DeleteTable' | translate: {Default: 'Delete Table'}">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </td>
        </tr>
      }
    </tbody>
  </table>
</div>

@if (loading()) {
  <ngm-spin class="absolute left-0 top-0 w-full h-full flex justify-center items-center" />
}

@if (table()) {
  <div class="absolute right-1 top-1 bottom-1 w-[800px] lg:w-[900px] xl:w-[1000px] px-6 py-4 bg-neutral-50 rounded-2xl border border-solid border-gray-200 shadow-lg max-w-[95vw] mx-auto overflow-auto z-10">
    <div class="flex justify-between items-center">
      <h2 class="text-xl font-semibold mb-4">{{ 'PAC.Workspace.EditTable' | translate: {Default: 'Edit Table'} }}</h2>
      <button type="button" class="flex justify-center items-center w-8 h-8 rounded-full hover:bg-gray-200 hover:text-text-destructive"
        (click)="table.set(null)">
        <i class="ri-close-line text-2xl"></i>
      </button>
    </div>

    <!-- Âü∫Êú¨‰ø°ÊÅØ -->
    <div class="space-y-4 bg-white p-4 rounded-lg border">
      <div>
        <label class="block text-sm font-medium mb-1">{{ 'PAC.Workspace.Database' | translate: {Default: 'Database'} }} *</label>
        <div>
          <ngm-select [placeholder]="'PAC.Workspace.SelectDatabase' | translate: {Default: 'Select Database'}" [selectOptions]="databases$ | async" [(ngModel)]="database" [nullable]="false" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">{{ 'PAC.Workspace.Schema' | translate: {Default: 'Schema'} }} *</label>
        <div>
          <ngm-select [placeholder]="'PAC.Workspace.SelectSchema' | translate: {Default: 'Select Schema'}" [selectOptions]="schemasOptions()" [(ngModel)]="schema" [nullable]="false" />
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-1">{{ 'PAC.Workspace.TableName' | translate: {Default: 'Table Name'} }} *</label>
        <input
          type="text"
          class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-blue-300"
          [(ngModel)]="name"
        />
      </div>
      

      <div>
        <label class="block text-sm font-medium mb-1">{{ 'PAC.Workspace.TableDescription' | translate: {Default: 'Table Description'} }}</label>
        <input
          type="text"
          class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-blue-300"
          [(ngModel)]="description"
        />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">{{ 'PAC.Workspace.QueryMode' | translate: {Default: 'Query Mode'} }}</label>
        <select
          class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-blue-300"
        >
          <option>{{ 'PAC.Workspace.SingleUserMode' | translate: {Default: 'Single User Mode'} }}</option>
          <option>{{ 'PAC.Workspace.MultiUserMode' | translate: {Default: 'Multi User Mode'} }}</option>
        </select>
      </div>
    </div>

    <!-- Â≠óÊÆµÂÆö‰πâ -->
    <div class="mt-6 bg-white p-4 rounded-lg border">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-md font-semibold text-gray-800">{{ 'PAC.Workspace.FieldDefinition' | translate: {Default: 'Field Definition'} }}</h3>
        <button
          (click)="addColumn()"
          class="px-4 py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 transition flex items-center gap-1"
        >
          <i class="ri-add-line"></i> {{ 'PAC.Workspace.AddField' | translate: {Default: 'Add Field'} }}
        </button>
      </div>

      <div class="space-y-3 max-h-[500px] overflow-y-auto pr-2 pl-4">
        @for (col of table().columns; track col; let i = $index) {
          <div class="relative border border-gray-200 rounded-xl p-4 bg-gradient-to-br from-white to-gray-50 hover:shadow-md hover:border-blue-300 transition-all ml-2">
            <!-- Â≠óÊÆµÂ∫èÂè∑Ê†áËÆ∞ -->
            <div class="absolute -left-5 top-1/2 -translate-y-1/2 w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold shadow-md">
              {{i + 1}}
            </div>

            <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫ - ‰ΩøÁî® flex Â∏ÉÂ±ÄÁ°Æ‰øù‰∏ÄË°åÊòæÁ§∫ -->
            <div class="flex items-start gap-3">
              <!-- Â≠óÊÆµÂêçÁß∞ -->
              <div style="width: 160px;">
                <label class="text-xs font-medium text-gray-700 block mb-1.5 flex items-center gap-1">
                  <i class="ri-text text-blue-500"></i> {{ 'PAC.Workspace.FieldName' | translate: {Default: 'Field Name'} }} <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
                  [(ngModel)]="col.name"
                  [placeholder]="'PAC.Workspace.FieldNamePlaceholder' | translate: {Default: 'e.g. user_id'}"
                />
              </div>

              <!-- ÊèèËø∞ -->
              <div style="width: 180px;">
                <label class="text-xs font-medium text-gray-700 block mb-1.5 flex items-center gap-1">
                  <i class="ri-file-text-line text-gray-500"></i> {{ 'PAC.KEY_WORDS.Description' | translate: {Default: 'Description'} }}
                </label>
                <input
                  type="text"
                  class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
                  [(ngModel)]="col.label"
                  [placeholder]="'PAC.Workspace.FieldDescription' | translate: {Default: 'Field description'}"
                />
              </div>

              <!-- Êï∞ÊçÆÁ±ªÂûã -->
              <div style="width: 200px;">
                <label class="text-xs font-medium text-gray-700 block mb-1.5 flex items-center gap-1">
                  <i class="ri-code-box-line text-purple-500"></i> {{ 'PAC.Workspace.DataType' | translate: {Default: 'Data Type'} }} <span class="text-red-500">*</span>
                </label>
                <ngm-select class="text-sm" [selectOptions]="types()" [(ngModel)]="col.type" [nullable]="false" />
              </div>

              <!-- Â≠óÊÆµÈïøÂ∫¶Ôºà‰ªÖÂ≠óÁ¨¶‰∏≤Á±ªÂûãÊòæÁ§∫Ôºâ -->
              @if (col.type === 'string' || col.type === 'text') {
                <div style="width: 90px;">
                  <label class="text-xs font-medium text-gray-700 block mb-1.5">{{ 'PAC.Workspace.Length' | translate: {Default: 'Length'} }}</label>
                  <input
                    type="number"
                    class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm text-center focus:outline-none focus:ring-2 focus:ring-blue-400"
                    [(ngModel)]="col.length"
                    [placeholder]="'PAC.Workspace.Length' | translate: {Default: 'Length'}"
                  />
                </div>
              }

              <!-- Á∫¶Êùü -->
              <div style="width: 150px;">
                <label class="text-xs font-medium text-gray-700 block mb-1.5 flex items-center gap-1">
                  <i class="ri-shield-line text-indigo-500"></i> {{ 'PAC.Workspace.Constraints' | translate: {Default: 'Constraints'} }}
                </label>
                <div class="relative">
                  <button
                    type="button"
                    class="w-full border border-gray-300 rounded-lg px-2.5 py-2 text-xs bg-white hover:bg-gray-50 hover:border-blue-400 flex items-center justify-between transition"
                    [cdkMenuTriggerFor]="constraintMenu"
                  >
                    <div class="flex gap-1 flex-wrap">
                      @if (col.isPrimaryKey) {
                        <span class="px-1.5 py-0.5 bg-yellow-100 text-yellow-700 rounded text-xs font-medium">{{ getConstraintLabelText('pk') }}</span>
                      }
                      @if (col.required) {
                        <span class="px-1.5 py-0.5 bg-red-100 text-red-700 rounded text-xs font-medium">{{ getConstraintLabelText('required') }}</span>
                      }
                      @if (col.isUnique && !col.isPrimaryKey) {
                        <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">{{ getConstraintLabelText('unique') }}</span>
                      }
                      @if (col.autoIncrement) {
                        <span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">{{ getConstraintLabelText('autoIncrement') }}</span>
                      }
                      @if (!col.isPrimaryKey && !col.required && !col.isUnique && !col.autoIncrement) {
                        <span class="text-gray-400 text-xs">{{ 'PAC.Workspace.NoConstraints' | translate: {Default: 'None'} }}</span>
                      }
                    </div>
                    <i class="ri-arrow-down-s-line text-gray-500 ml-1 flex-shrink-0"></i>
                  </button>
                  
                  <ng-template #constraintMenu>
                    <div cdkMenu class="cdk-menu w-56 p-3 shadow-xl">
                      <div class="space-y-1.5">
                        <label class="flex items-center justify-between px-3 py-2.5 hover:bg-blue-50 rounded-lg cursor-pointer transition group">
                          <span class="text-sm flex items-center gap-2">
                            <i class="ri-key-line text-yellow-600 text-base group-hover:scale-110 transition"></i>
                            <span class="font-medium">{{ 'PAC.Workspace.PrimaryKey' | translate: {Default: 'Primary Key'} }}</span>
                          </span>
                          <input type="checkbox" class="h-4 w-4 text-blue-600 rounded" [(ngModel)]="col.isPrimaryKey" />
                        </label>
                        <label class="flex items-center justify-between px-3 py-2.5 hover:bg-blue-50 rounded-lg cursor-pointer transition group">
                          <span class="text-sm flex items-center gap-2">
                            <i class="ri-error-warning-line text-red-600 text-base group-hover:scale-110 transition"></i>
                            <span class="font-medium">{{ 'PAC.Workspace.Required' | translate: {Default: 'Required'} }}</span>
                            <span class="text-xs text-gray-500">(NOT NULL)</span>
                          </span>
                          <input type="checkbox" class="h-4 w-4 text-blue-600 rounded" [(ngModel)]="col.required" />
                        </label>
                        <label class="flex items-center justify-between px-3 py-2.5 hover:bg-blue-50 rounded-lg cursor-pointer transition group"
                          [class.opacity-50]="col.isPrimaryKey">
                          <span class="text-sm flex items-center gap-2">
                            <i class="ri-shield-check-line text-blue-600 text-base group-hover:scale-110 transition"></i>
                            <span class="font-medium">{{ 'PAC.Workspace.Unique' | translate: {Default: 'Unique'} }}</span>
                          </span>
                          <input type="checkbox" class="h-4 w-4 text-blue-600 rounded" [(ngModel)]="col.isUnique" [disabled]="col.isPrimaryKey" />
                        </label>
                        <label class="flex items-center justify-between px-3 py-2.5 hover:bg-blue-50 rounded-lg cursor-pointer transition group"
                          [class.opacity-50]="col.type !== 'number' && col.type !== 'bigint'">
                          <span class="text-sm flex items-center gap-2">
                            <i class="ri-add-circle-line text-green-600 text-base group-hover:scale-110 transition"></i>
                            <span class="font-medium">{{ 'PAC.Workspace.AutoIncrement' | translate: {Default: 'Auto Increment'} }}</span>
                          </span>
                          <input type="checkbox" class="h-4 w-4 text-blue-600 rounded" [(ngModel)]="col.autoIncrement" 
                            [disabled]="col.type !== 'number' && col.type !== 'bigint'" />
                        </label>
                      </div>
                    </div>
                  </ng-template>
                </div>
              </div>

              <!-- ÈªòËÆ§ÂÄº -->
              <div style="width: 170px;">
                <label class="text-xs font-medium text-gray-700 block mb-1.5 flex items-center gap-1">
                  <i class="ri-layout-column-line text-teal-500"></i> {{ 'PAC.Workspace.DefaultValue' | translate: {Default: 'Default Value'} }}
                </label>
                @if (col.type === 'date' || col.type === 'datetime' || col.type === 'timestamp' || col.type === 'time') {
                  <select
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent bg-white"
                    [(ngModel)]="col.defaultValue"
                  >
                    <option value="">{{ 'PAC.Workspace.NoDefault' | translate: {Default: 'None'} }}</option>
                    @if (col.type === 'date') {
                      <option value="CURRENT_DATE">üìÖ {{ 'PAC.Workspace.CurrentDate' | translate: {Default: 'Current Date'} }}</option>
                    }
                    @if (col.type === 'time') {
                      <option value="CURRENT_TIME">üïê {{ 'PAC.Workspace.CurrentTime' | translate: {Default: 'Current Time'} }}</option>
                    }
                    @if (col.type === 'datetime' || col.type === 'timestamp') {
                      <option value="CURRENT_TIMESTAMP">üìÖ {{ 'PAC.Workspace.CurrentTimestamp' | translate: {Default: 'Current Timestamp'} }}</option>
                    }
                  </select>
                } @else {
                  <input
                    type="text"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
                    [(ngModel)]="col.defaultValue"
                    [placeholder]="'PAC.Workspace.DefaultValue' | translate: {Default: 'Default value'}"
                  />
                }
              </div>

              <!-- Âà†Èô§ÊåâÈíÆ -->
              <div class="flex items-end">
                <button type="button"
                  (click)="removeColumn(i)"
                  class="px-3 py-2 text-red-500 hover:bg-red-50 border border-transparent hover:border-red-300 rounded-lg transition group"
                  [title]="'PAC.KEY_WORDS.Delete' | translate: {Default: 'Delete'}"
                >
                  <i class="ri-delete-bin-line text-lg group-hover:scale-110 transition"></i>
                </button>
              </div>
            </div>
          </div>
        }

        @if (table().columns?.length === 0) {
          <div class="text-center py-12 text-gray-400">
            <i class="ri-inbox-line text-5xl mb-2"></i>
            <p class="text-sm">{{ 'PAC.Workspace.NoFields' | translate: {Default: 'No fields'} }}</p>
            <p class="text-xs mt-1">{{ 'PAC.Workspace.ClickAddField' | translate: {Default: 'Click "Add Field" button above to add fields'} }}</p>
          </div>
        }
      </div>
    </div>

    <!-- ‰øùÂ≠òÊåâÈíÆ -->
    <div class="mt-6 text-right">
      <button
        (click)="save()"
        class="btn btn-primary btn-large transition"
      >
        {{ 'PAC.KEY_WORDS.Save' | translate: {Default: 'Save'} }}
      </button>
    </div>
  </div>
}

<ng-template #moreMenu>
  <div cdkMenu class="cdk-menu__large">
    <div cdkMenuItem >
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-text-tertiary mr-1" data-icon="FilePlus02" aria-hidden="true"><path d="M13.3333 6.99992V4.53325C13.3333 3.41315 13.3333 2.85309 13.1153 2.42527C12.9236 2.04895 12.6176 1.74299 12.2413 1.55124C11.8135 1.33325 11.2534 1.33325 10.1333 1.33325H5.86666C4.74655 1.33325 4.1865 1.33325 3.75868 1.55124C3.38235 1.74299 3.07639 2.04895 2.88464 2.42527C2.66666 2.85309 2.66666 3.41315 2.66666 4.53325V11.4666C2.66666 12.5867 2.66666 13.1467 2.88464 13.5746C3.07639 13.9509 3.38235 14.2569 3.75868 14.4486C4.1865 14.6666 4.74655 14.6666 5.86666 14.6666H7.99999M9.33332 7.33325H5.33332M6.66666 9.99992H5.33332M10.6667 4.66659H5.33332M12 13.9999V9.99992M9.99999 11.9999H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
      {{ 'PAC.Xpert.BulkImport' | translate: {Default: 'Bulk Import'} }}
    </div>

  </div>
</ng-template>