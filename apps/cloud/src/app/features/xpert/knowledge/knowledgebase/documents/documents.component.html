<div class="flex flex-col justify-center gap-1 px-6 pt-4">
  @if (parentId()) {
    <nav class="flex" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
        <li class="inline-flex items-center">
          <a class="inline-flex items-center font-medium cursor-pointer text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white"
            (click)="backHome()">
            <i class="ri-home-2-line"></i>
            {{ 'PAC.Knowledgebase.Root' | translate: {Default: 'Root'} }}
          </a>
        </li>
        @if (grandParent(); as grand) {
          <li>
            <div class="flex items-center">
              <i class="ri-arrow-right-s-line text-lg text-gray-400 mx-1"></i>
              <i class="ri-folder-2-line text-gray-400"></i>
              <a [routerLink]="['.']" [queryParams]="{parentId: grand.id}" class="ms-1 font-medium text-gray-700 hover:text-blue-600 md:ms-2 dark:text-gray-400 dark:hover:text-white">
                {{ grand.name }}
              </a>
            </div>
          </li>
        }
        <li aria-current="page">
          <div class="flex items-center">
            <i class="ri-arrow-right-s-line text-lg text-gray-400 mx-1"></i>
            <i class="ri-folder-2-line text-gray-400"></i>
            <span class="ms-1 font-medium text-gray-500 md:ms-2 dark:text-gray-400">
              {{ parentFolder()?.name }}
            </span>
          </div>
        </li>
      </ol>
    </nav>
  } @else {
    <h1 class="text-lg font-semibold text-text-primary">{{ 'PAC.Knowledgebase.Files' | translate: {Default: 'Files'} }}</h1>
  }
  <div class="flex items-center space-x-0.5 text-sm font-normal text-text-tertiary">
    <span>
      {{ 'PAC.Knowledgebase.DocumentsDescription' | translate: {Default: 'All files in the knowledge base are displayed here, and the entire knowledge base can be applied to the digital expert agent or project space.' } }}
    </span>
    <a class="flex items-center text-text-accent" target="_blank" [href]="helpUrl()">
      <span>{{ 'PAC.KEY_WORDS.LearnMore' | translate: {Default: 'Learn more'} }}</span>
      <i class="ri-corner-right-up-line "></i>
    </a>
  </div>
</div>

<div class="flex items-center justify-between flex-column md:flex-row flex-wrap space-y-4 md:space-y-0 p-4 bg-white dark:bg-gray-900">
  <div class="relative w-[160px]">
    <i class="ri-search-2-line flex justify-center items-center absolute left-2 top-1/2 h-4 w-4 -translate-y-1/2 text-components-input-text-placeholder"></i>
    <input class="w-full appearance-none border border-transparent bg-components-input-bg-normal py-1.5 text-components-input-text-filled caret-primary-600 outline-none placeholder:text-components-input-text-placeholder hover:border-components-input-border-hover hover:bg-components-input-bg-hover focus:border-components-input-border-active focus:bg-components-input-bg-active focus:shadow-xs px-3 radius-md system-sm-regular pl-[26px]"
      [placeholder]="'PAC.KEY_WORDS.Search' | translate: {Default: 'Search'}"
      [(ngModel)]="search"
    >
    @if (search()) {
      <i class="ri-close-circle-line cursor-pointer flex justify-center items-center absolute right-2 top-1/2 h-4 w-4 -translate-y-1/2 text-components-input-text-placeholder hover:text-text-primary"
        (click)="search.set('')"></i>
    }
  </div>

  <div class="flex items-center gap-4">
    <button type="button" class="btn disabled:btn-disabled btn-secondary btn-medium shrink-0"
      [cdkMenuTriggerFor]="metadataTemplate"
      #ref="cdkMenuTriggerFor"
      [cdkMenuTriggerData]="{ref: ref}">
      <i class="ri-file-info-line mr-1"></i>
      {{ 'PAC.Knowledgebase.Metadata' | translate: {Default: 'Metadata'} }}
    </button>
    <button type="button" class="btn btn-primary btn-large flex justify-center items-center gap-2"
      [matTooltip]=" 'PAC.Knowledgebase.NewDocuments' | translate: {Default: 'New Documents' }"
      matTooltipPosition="before"
      [cdkMenuTriggerFor]="docMenu"
    >
      <i class="ri-folder-shared-fill"></i>
      <span>{{ 'PAC.Knowledgebase.NewUpload' | translate: {Default: 'New / Upload'} }}</span>
    </button>
  </div>
</div>
<div class="relative px-4 overflow-x-auto">
  <table class="table-fixed w-full text-sm text-left text-gray-500 dark:text-gray-400">
    <thead class="text-sm text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
      <tr>
        <th scope="col" class="px-6 py-3 w-20">
          <ngm-checkbox class="shrink-0" [indeterminate]="isPartialSelected()"
            [ngModel]="isAllSelected()" (ngModelChange)="selectAll($event)"
            >#</ngm-checkbox>
        </th>
        <th scope="col" class="px-6 py-3">
          {{ 'PAC.KEY_WORDS.Name' | translate: {Default: 'Name'} }}
        </th>
        @for (column of columnsToDisplay; track column.name) {
          @switch (column.name) {
            @case ('disabled') {
              <th scope="col" class="px-6 py-3 w-24">
                {{ 'PAC.KEY_WORDS.' + column.caption | translate: {Default: column.caption} }}
              </th>
            }
            @case ('processMsg') {
              <th scope="col" class="px-6 py-3 w-60">
                {{ 'PAC.KEY_WORDS.Message' | translate: {Default: 'Message'} }}
              </th>
            }
            @default {
              <th scope="col" class="px-6 py-3 w-44">
                {{ 'PAC.KEY_WORDS.' + column.caption | translate: {Default: column.caption} }}
              </th>
            }
          }
        }
        <th scope="col" class="px-6 py-3 w-28">
          {{ 'PAC.Knowledgebase.ParsingProgress' | translate: {Default: 'Parsing Progress'} }}
        </th>
        <th scope="col" class="px-6 py-3 w-28">
          {{ 'PAC.KEY_WORDS.Actions' | translate: {Default: 'Actions'} }}
        </th>
      </tr>
    </thead>

    <tbody>
      @for (element of filteredData(); track element.id; let i = $index) {
        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
          <td class="px-6 py-2">
            <ngm-checkbox class="shrink-0" [disabled]="element.sourceType === eKDocumentSourceType.FOLDER"
              [ngModel]="selectionModel.isSelected(element.id)" (ngModelChange)="selectionModel.toggle(element.id)">
              {{i + 1}}
            </ngm-checkbox> 
          </td>
          <td class="px-6 py-2">
            @if (element.sourceType === eKDocumentSourceType.FOLDER) {
              <a [routerLink]="['.']" [queryParams]="{parentId: element.id}" class="hover:underline">
                <knowledge-doc-id [doc]="element" [searchText]="search()" />
              </a>
            } @else {
              <a [routerLink]="['.', element.id]" [queryParams]="{parentId: parentId()}" class="cursor-pointer hover:underline">
                <knowledge-doc-id [doc]="element" [searchText]="search()" />
              </a>
            }
          </td>
          @for (column of columnsToDisplay; track column.name) {
            @switch (column.name) {
              @case ('disabled') {
                <td class="px-6 py-2 w-24">
                  <div class="flex items-center text-sm">
                    <ngm-slide-toggle [ngModel]="!element.disabled" (ngModelChange)="updateDocument(element.id, { disabled: !$event })" />
                  </div>
                </td>
              }
              @case ('processMsg') {
                <td class="px-6 py-2 w-60">
                  <div class="max-w-sm truncate text-sm text-red-600 dark:text-red-400" [title]="element.processMsg">
                    {{element.processMsg}}
                  </div>
                </td>
              }
              @default {
                <td class="px-6 py-2 w-44">
                {{ getValue(element, column.name) }}
                </td>
              }
            }
          }

          <!-- progress Column -->
          <td class="px-6 py-2 w-36">
            @if (element.sourceType !== eKDocumentSourceType.FOLDER) {
              <div class="cursor-pointer" (click)="openTask(element)">
                @switch (element.status) {
                  @case (eKBDocumentStatusEnum.RUNNING) {
                    <ngm-tags class="text-sm"
                      [tags]="[{ caption: 'PAC.Knowledgebase.Status_Running' | translate: {Default: 'Running'} }]"
                      color="blue" />
                  }
                  @case (eKBDocumentStatusEnum.FINISH) {
                    <ngm-tags class="text-sm"
                      [tags]="[{ caption: 'PAC.Knowledgebase.Status_Finish' | translate: {Default: 'Finish'} }]"
                      color="green" />
                  }
                  @case (eKBDocumentStatusEnum.ERROR) {
                    <ngm-tags class="text-sm" [matTooltip]="element.processMsg" matTooltipPosition="left"
                      [tags]="[{ caption: 'PAC.Knowledgebase.Status_Error' | translate: {Default: 'Error'} }]"
                      color="red" />
                  }
                  @case (eKBDocumentStatusEnum.WAITING) {
                    <ngm-tags class="text-sm"
                      [tags]="[{ caption: 'PAC.Knowledgebase.Status_Waiting' | translate: {Default: 'Waiting'} }]"
                      color="orange" />
                  }
                  @case (eKBDocumentStatusEnum.TRANSFORMED) {
                    <ngm-tags class="text-sm"
                      [tags]="[{ caption: 'PAC.Knowledgebase.Status_Transformed' | translate: {Default: 'Transformed'} }]"
                      color="orange" />
                  }
                  @case (eKBDocumentStatusEnum.SPLITTED) {
                    <ngm-tags class="text-sm"
                      [tags]="[{ caption: 'PAC.Knowledgebase.Status_Splitted' | translate: {Default: 'Splitted'} }]"
                      color="orange" />
                  
                  }
                  @case (eKBDocumentStatusEnum.UNDERSTOOD) {
                    <ngm-tags class="text-sm"
                      [tags]="[{ caption: 'PAC.Knowledgebase.Status_Understood' | translate: {Default: 'Understood'} }]"
                      color="orange" />
                  }
                  @case (eKBDocumentStatusEnum.EMBEDDING) {
                    
                    <div class="flex items-center gap-1">
                      <ngm-progress-spinner class="w-6 h-6 shrink-0" [value]="element.progress" />
                      <span>{{element.progress}}%</span>
                    </div>
                  }
                  @default {
                    <ngm-tags class="text-sm"
                      [tags]="[{ caption: 'PAC.Knowledgebase.Status_NotStart' | translate: {Default: 'Not Start'} }]"
                      color="gray" />
                  }
                }
              </div>
            }
          </td>
          <td class="px-6 py-2 w-28">
            <div class="flex items-center">
              @if (element.sourceType !== eKDocumentSourceType.FOLDER) {
                <button class="w-6 h-6 shrink-0 cursor-pointer rounded-lg p-0.5 hover:bg-state-base-hover"
                  (click)="openChunkSettings(element)">
                  <i class="ri-equalizer-2-line"></i>
                </button>
                <div class="shrink-0 w-[1px] mx-2 bg-divider-deep !h-3"></div>
              }
              <button
                class="w-6 h-6 shrink-0 mr-2 cursor-pointer rounded-lg p-0.5 hover:bg-state-base-hover"
                type="button"
                [cdkMenuTriggerFor]="rowMenu"
                [cdkMenuTriggerData]="{ doc: element }"
              >
                <i class="ri-more-fill"></i>
              </button>
            </div>
          </td>
        </tr>
      }
    </tbody>
  </table>
</div>

@if (selectionModel.hasValue()) {
  <div class="absolute bottom-12 left-1/2 -translate-x-1/2 px-16 py-2 whitespace-nowrap z-10">
    <div class="rounded-xl flex justify-center items-center gap-2 p-2 shadow-lg border-[0.5px] border-solid border-primary-400 bg-primary-50">
      <div class="inline-flex items-center gap-x-2 py-1 pl-2 pr-3">
        <span class="system-xs-medium flex h-5 w-5 items-center justify-center rounded-md bg-text-accent text-text-primary-on-surface">
          {{selectionModel.selected.length}}
        </span>
        <span class="system-sm-semibold text-text-accent">
          {{ 'PAC.KEY_WORDS.Selected' | translate: {Default: 'Selected'} }}
        </span>
      </div>
      <div class="shrink-0 w-[1px] mx-2 bg-divider-deep !h-3"></div>
      <button type="button" class="btn btn-secondary btn-large"
        (click)="enableSelected()"
        >
        <i class="ri-checkbox-circle-line mr-1"></i>
        {{ 'PAC.ACTIONS.Enable' | translate: {Default: "Enable"} }}
      </button>
      <button type="button" class="btn btn-secondary btn-large" 
        (click)="disableSelected()"
        >
        <i class="ri-close-circle-line mr-1"></i>
        {{ 'PAC.ACTIONS.Disable' | translate: {Default: "Disable"} }}
      </button>
      <button type="button" class="btn btn-secondary btn-large" 
        (click)="reprocess(selectionModel.selected)">
        <i class="ri-reset-right-line mr-1"></i>
        <span>{{ 'PAC.Knowledgebase.Reprocess' | translate: {Default: 'Reprocess'} }}</span>
      </button>
      <div class="shrink-0 w-[1px] mx-2 bg-divider-deep !h-3"></div>
      <button type="button" class="btn btn-large btn-secondary danger" (click)="deleteSelected()">
        <i class="ri-delete-bin-line mr-1"></i>
        {{ 'PAC.ACTIONS.Delete' | translate: {Default: 'Delete'} }}
      </button>
    </div>
  </div>
}

@if (isLoading()) {
  <ngm-spin class="absolute top-0 left-0 w-full h-full" />
}

<router-outlet #o="outlet"></router-outlet>

<ng-template #docMenu>
  <div cdkMenu class="cdk-menu__large">
    <div cdkMenuItem (click)="createFolder()">
      <i class="ri-folder-add-fill mr-1 text-xl text-text-accent"></i>
      <span class="ml-2">{{ 'PAC.Knowledgebase.NewFolder' | translate: {Default: 'New Folder'} }}</span>
    </div>
    <div cdkMenuItem [cdkMenuItemDisabled]="!hasPipeline()"
      [matTooltip]="hasPipeline() ? ('PAC.Knowledgebase.AddDocumentFromPipeline' | translate: {Default: 'Use pipelines to create documents and convert them'}) : ('PAC.Knowledgebase.CreatePipelineFirst' | translate: {Default: 'Create and publish a knowledge pipeline first.'})"
      matTooltipPosition="left"
      [class.opacity-50]="!hasPipeline()"
      [class.!cursor-pointer]="!hasPipeline()"
      (click)="hasPipeline()&&createFromPipeline()">
      <i class="ri-flow-chart mr-1 text-xl text-primary-600"></i>
      <span class="ml-2">{{ 'PAC.Knowledgebase.CreateFromPipeline' | translate: {Default: 'Create From Pipeline'} }}</span>
    </div>
    <div cdkMenuItem
      [matTooltip]="'PAC.Knowledgebase.AddDocumentFixedConfig' | translate: {Default: 'Add a new document and convert it with a fixed configuration.'}"
      matTooltipPosition="left"
      (click)="uploadDocuments()">
      <i class="ri-folder-shared-fill mr-1 text-xl text-text-success"></i>
      <span class="ml-2">{{ 'PAC.Knowledgebase.NewDocuments' | translate: {Default: 'New Documents' } }}</span>
    </div>
  </div>
</ng-template>

<ng-template #rowMenu let-doc="doc">
  <div cdkMenu class="cdk-menu__large">
    @if (doc.sourceType !== eKDocumentSourceType.FOLDER) {
      <div cdkMenuItem (click)="reprocess([doc.id])">
        <i class="ri-reset-right-line mr-2"></i>
        <span>{{ 'PAC.Knowledgebase.Reprocess' | translate: {Default: 'Reprocess'} }}</span>
      </div>
    }
    <div cdkMenuItem (click)="enableDoc(doc)">
      <i class="ri-checkbox-circle-line mr-2"></i>
      {{ 'PAC.ACTIONS.Enable' | translate: {Default: "Enable"} }}
    </div>
    <div cdkMenuItem class="danger" (click)="disableDoc(doc)">
      <i class="ri-close-circle-line mr-2"></i>
      {{ 'PAC.ACTIONS.Disable' | translate: {Default: "Disable"} }}
    </div>
    <div class="w-full border-t border-solid border-divider-regular my-1"></div>
    <div cdkMenuItem (click)="renameDoc(doc)">
      <i class="ri-edit-line mr-2"></i>
      <span>{{ 'PAC.ACTIONS.Rename' | translate: {Default: 'Rename'} }}</span>
    </div>
    <div cdkMenuItem class="danger" (click)="deleteDocument(doc)">
      <i class="ri-delete-bin-line mr-2"></i>
      <span>{{ 'PAC.ACTIONS.Delete' | translate: {Default: 'Delete' } }}</span>
    </div>
  </div>
</ng-template>


<ng-template #metadataTemplate let-ref="ref">
  <div class="p-4 rounded-2xl shadow-lg w-[500px] overflow-hidden bg-components-panel-bg-blur">
    <div class="flex justify-between">
      <h3 class="text-lg font-medium leading-6 text-text-primary">
        {{ 'PAC.Knowledgebase.MetadataFields' | translate: {Default: 'Metadata Fields'} }}
      </h3>
      <button type="button" class="btn btn-ghost btn-small w-7 h-7 rounded-full"
        (click)="ref.close()">
        <i class="ri-close-line text-lg"></i>
      </button>
    </div>

    <div class="system-sm-regular text-text-tertiary">
      {{ 'PAC.Knowledgebase.MetadataFieldsDescription' | translate: {Default: 'Metadata is data about documents that describes the attributes of the documents. Metadata can help you better organize and manage documents.' } }}
    </div>

    <div class="inline-block" >
      <button type="button" class="btn disabled:btn-disabled btn-primary btn-medium mt-3" (click)="addMetadataField()">
        <i class="ri-add-large-line"></i>
        {{ 'PAC.Knowledgebase.AddField' | translate: {Default: 'Add Field'} }}
      </button>
    </div>

    <div class="mt-3 space-y-1">
      @for (field of metadataSchema(); track i; let i = $index) {
        <div
          class="group/item cursor-pointer hover:shadow-xs rounded-md border border-components-panel-border-subtle bg-components-panel-on-panel-item-bg">
          <div class="flex h-8 items-center justify-between px-2">
            <div class="flex-1 flex h-full items-center space-x-1 text-sm text-text-tertiary">
              @switch (field.type) {
                @case ('string') {
                  <i class="ri-text-snippet"></i>
                }
                @case ('number') {
                  <i class="ri-hashtag"></i>
                }
                @case ('datetime') {
                  <i class="ri-time-line"></i>
                }
              }
              <input class="system-sm-medium max-w-[250px] px-1 truncate text-text-primary outline-none rounded-sm focus:bg-components-input-bg" [ngModel]="field.key" (ngModelChange)="updateMetadataField(i, 'key', $event)">
              <div class="system-xs-regular shrink-0 px-2 rounded-md"
              [cdkMenuTriggerFor]="metadataTypeMenu"
              [cdkMenuTriggerData]="{index: i}"
              >{{field.type}}</div>
              <input class="system-sm-medium grow px-1 truncate text-text-primary outline-none rounded-sm focus:bg-components-input-bg"
                [placeholder]="'PAC.KEY_WORDS.Description' | translate: {Default: 'description'}"
                [ngModel]="field.description" (ngModelChange)="updateMetadataField(i, 'description', $event)">
            </div>
            <!-- <div class="system-xs-regular ml-2 shrink-0 text-text-tertiary group-hover/item:hidden">1个值</div> -->
            <div class="ml-2 hidden items-center space-x-1 text-text-tertiary group-hover/item:flex">
              <div class="w-6 h-6 flex justify-center items-center rounded-md hover:bg-hover-bg hover:text-text-destructive"
                (click)="removeMetadata(i)">
                <i class="ri-delete-bin-line"></i>
              </div>
            </div>
          </div>
        </div>
      }
    </div>

    <div class="mt-3 space-y-1">
      @for (g of STANDARD_METADATA_FIELDS; track g) {
        <div class="mt-2">{{ g.group | i18n }}</div>
        @for (field of g.fields; track i; let i = $index) {
          <div
            class="group/item cursor-pointer hover:shadow-xs rounded-md border border-components-panel-border-subtle bg-components-panel-on-panel-item-bg">
            <div class="flex h-8 items-center justify-between px-2 text-sm">
              <div class="flex h-full items-center space-x-1 text-text-tertiary">
                @switch (field.type) {
                  @case ('string') {
                    <i class="ri-text-snippet"></i>
                  }
                  @case ('number') {
                    <i class="ri-hashtag"></i>
                  }
                  @case ('datetime') {
                    <i class="ri-time-line"></i>
                  }
                }
                <div class="system-sm-medium max-w-[250px] truncate text-text-primary outline-none">
                  {{ field.key }} / {{ field.label | i18n }}
                </div>
                <div class="system-xs-regular shrink-0">{{field.type}}</div>
              </div>
              <!-- <div class="system-xs-regular ml-2 shrink-0 text-text-tertiary group-hover/item:hidden">1个值</div> -->
            </div>
          </div>
        }
      }
    </div>

    <div class="w-full flex justify-end mt-4">
      <button type="button" class="mt-2 btn btn-primary btn-large"
        (click)="saveMetadataSchema(ref)">
        {{ 'PAC.ACTIONS.Save' | translate: {Default: 'Save'} }}
      </button>
    </div>
  </div>
</ng-template>

<ng-template #metadataTypeMenu let-index="index">
  <div cdkMenu class="cdk-menu__medium">
    <div cdkMenuItem (click)="updateMetadataField(index, 'type', 'string')">
      <i class="ri-text-snippet mr-2"></i>
      <span>String</span>
    </div>
    <div cdkMenuItem (click)="updateMetadataField(index, 'type', 'number')">
      <i class="ri-hashtag mr-2"></i>
      <span>Number</span>
    </div>
    <div cdkMenuItem (click)="updateMetadataField(index, 'type', 'datetime')">
      <i class="ri-time-line mr-2"></i>
      <span>DateTime</span>
    </div>
  </div>
</ng-template>