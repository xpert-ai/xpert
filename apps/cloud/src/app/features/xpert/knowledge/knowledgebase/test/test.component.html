<div class="shrink-0 w-[588px] max-w-2xl flex flex-col px-6 py-3">
  <div class="mb-4 flex flex-col justify-center">
    <h1 class="text-lg font-semibold text-text-primary">
      {{ 'PAC.Knowledgebase.RetrievalTest' | translate: {Default: 'Retrieval Test'} }}
    </h1>
    <p class="mt-0.5 text-[13px] font-body leading-4 text-text-tertiary">
      {{ 'PAC.Knowledgebase.TestTheHittingEffect' | translate: {Default: 'Test the hitting effect of the Knowledge based on the given query text.'} }}
    </p>
  </div>

  <div class="relative bg-gradient-to-r from-blue-500 to-orange-500 rounded-[12px] p-[2px] mb-4 shadow-xs">
    <div class="relative rounded-t-xl bg-neutral-100 pt-1.5">
      <div class="flex h-8 items-center justify-between pb-1 pl-4 pr-1.5">
        <span class="text-[13px] font-semibold uppercase leading-4 text-text-secondary">
          {{ 'PAC.Knowledgebase.SourceText' | translate: {Default: 'Source text'} }}
        </span>
        <div
          class="flex h-7 cursor-pointer items-center space-x-0.5 rounded-lg border-[0.5px] border-components-button-secondary-bg bg-components-button-secondary-bg px-1.5 shadow-xs backdrop-blur-[5px]
            hover:bg-components-button-secondary-bg-hover"
          [cdkMenuTriggerFor]="vectorMenu"
          #cdkMenu="cdkMenuTriggerFor"
        >
          <i class="ri-focus-mode mr-1"></i>
          <div class="text-xs font-medium uppercase select-none text-text-secondary">
            {{ 'PAC.Knowledgebase.VectorSearch' | translate: {Default: 'Vector Search'} }}
          </div>
          <i class="ri-equalizer-2-line"></i>
        </div>
      </div>
    </div>

    <div class="rounded-b-xl bg-white px-4 py-2 pb-11">
      <textarea class="h-[160px] w-full resize-none border-none bg-transparent text-sm font-normal font-body text-text-secondary caret-[#295EFF]
        placeholder:text-sm placeholder:font-normal placeholder:text-components-input-text-placeholder focus-visible:outline-none"
        [placeholder]="'PAC.Knowledgebase.EnterQueryText' | translate: {Default: 'Please enter a text, a short declarative sentence is recommended.'}"
        [(ngModel)]="query"
        [disabled]="loading()"
      ></textarea>
      <div class="absolute inset-x-0 bottom-0 mx-4 mb-2 mt-2 flex items-center justify-between">
        <div class="flex h-5 items-center rounded-md bg-background-section-burn px-1 text-xs font-medium text-text-tertiary">
          {{query().length}}<span class="mx-0.5 text-divider-deep">/</span>200
        </div>
        <div>
          <button type="button" class="btn disabled:btn-disabled btn-primary btn-medium w-[88px]"
            [disabled]="loading() || !query()" (click)="test()"
          >{{'PAC.Knowledgebase.Test' | translate: {Default: 'Test'} }}
          </button>
        </div>
      </div>
    </div>
  </div>

  
  <div class="mb-3 mt-6 text-base font-semibold text-text-primary">
    {{ 'PAC.Knowledgebase.TestRecords' | translate: {Default: 'Test Records'} }}
  </div>
  <div class="grow overflow-y-auto">
    <table class="w-full border-collapse border-0 text-[13px] leading-4 text-text-secondary">
      <thead class="sticky top-0 h-7 text-xs font-medium uppercase leading-7 text-text-tertiary backdrop-blur-[5px]">
        <tr>
          <td class="w-[128px] rounded-l-lg bg-background-section-burn pl-3">
            {{ 'PAC.Knowledgebase.Source' | translate: {Default: 'Source'} }}
          </td>
          <td class="bg-background-section-burn">
            {{ 'PAC.Knowledgebase.Text' | translate: {Default: 'Text'} }}
          </td>
          <td class="w-48 rounded-r-lg bg-background-section-burn pl-2">
            {{ 'PAC.Knowledgebase.Time' | translate: {Default: 'Time'} }}
          </td>
        </tr>
      </thead>
      <tbody>
        @for (log of logs(); track log.id; let i = $index) {
          <tr class="group h-10 cursor-pointer border-b border-divider-subtle hover:bg-background-default-hover"
            (click)="selectLog(log)">
            <td class="w-[128px] pl-3">
              <div class="flex items-center">
                <i class="ri-focus-2-line"></i>
                <span class="capitalize">
                  @switch (log.source) {
                    @case ('hit_testing') {
                      {{ 'PAC.Knowledgebase.RetrievalTest' | translate: {Default: 'Retrieval Test'} }}
                    }
                    @case ('retriever') {
                      {{ 'PAC.Knowledgebase.Retriever' | translate: {Default: 'Retriever'} }}
                    }
                    @default {
                      {{ 'PAC.Knowledgebase.Unknown' | translate: {Default: 'unknown'} }}
                    }
                  }
                </span>
              </div>
            </td>
            <td class="max-w-xs py-2">{{ log.query }}</td>
            <td class="w-36 pl-2">{{ log.createdAt | date: 'short' }}</td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>

<div class="relative shrink-0 flex-1 flex flex-col pt-3 overflow-auto">
  @if (results()) {
    <div class="flex h-full flex-col rounded-tl-2xl bg-background-body px-4 py-3">
      <div class="mb-2 shrink-0 pl-2 font-semibold leading-6 text-text-primary">{{ results().length }} {{ 'PAC.Knowledgebase.RecallParagraphs' | translate: {Default: 'recall paragraphs'} }}</div>
      <div class="grow space-y-2">
        @for (chunk of results(); track chunk.id; let i = $index) {
          <xp-knowledge-chunk [chunk]="chunk" [index]="i"/>
        }
      </div>
    </div>

    @if (loading()) {
      <ngm-spin class="absolute left-0 top-0 w-full h-full " />
    }
  } @else {
    <div class="absolute top-0 left-0 w-full h-full flex flex-col justify-center items-center gap-2 text-text-tertiary">
      <i class="ri-crosshair-2-line text-6xl" [class.animate-spin]="loading()"></i>
      <div class="">{{'PAC.Knowledgebase.RetrievalTestingResultsHere' | translate: {Default: 'Retrieval Testing results will show here'} }}
      </div>
    </div>
  }
</div>


<ng-template #vectorMenu>
  <div class="bg-components-card-bg rounded-2xl border border-divider-deep shadow-lg p-3">
    <div class="flex shrink-0 justify-between pl-3 pb-1 pt-1">
      <div class="text-base font-semibold text-text-primary">
        <div>{{ 'PAC.Knowledgebase.RetrievalSetting' | translate: {Default: 'Retrieval Setting'} }}</div>
        <div class="text-xs font-normal leading-[18px] font-body text-text-tertiary">
          <a
            target="_blank"
            rel="noopener noreferrer"
            [href]="helpUrl()"
            class="text-text-accent"
            >{{ 'PAC.KEY_WORDS.LearnMore' | translate: {Default: 'Learn more'} }}</a>
          {{ 'PAC.Knowledgebase.AboutRetrievalMethod' | translate: {Default: ' about retrieval method.'} }}
        </div>
      </div>
      <div class="flex">
        <div class="flex h-8 w-8 cursor-pointer items-center justify-center rounded-lg hover:bg-hover-bg"
          (click)="onClose(false);cdkMenu.close()">
          <i class="ri-close-line"></i>
        </div>
      </div>
    </div>
    <xp-knowledge-retrieval-settings savable [ngModel]="knowledgebase()" (close)="onClose($event);cdkMenu.close()" />
  </div>
</ng-template>