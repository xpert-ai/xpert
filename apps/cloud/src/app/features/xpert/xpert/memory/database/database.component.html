<p class="p-2 system-sm-regular text-text-tertiary">日志记录了应用的运行情况，包括用户的输入和 AI 的回复。</p>

<div class="flex justify-between items-center gap-2 px-4">
  <div class="grow"></div>
  
  <div class="flex space-x-2">
    <button type="button" class="btn disabled:btn-disabled btn-primary btn-medium"
      (click)="addTable()">
      <i class="ri-add-line mr-1"></i>
      <div>{{ 'PAC.Xpert.NewTable' | translate: {Default: 'New Table'} }}</div>
    </button>
    <div class="relative">
      <button type="button" class="btn disabled:btn-disabled btn-secondary btn-medium w-8 p-0"
        [cdkMenuTriggerFor]="moreMenu"
      >
        <i class="ri-more-line"></i>
      </button>
    </div>
  </div>
</div>

<div class="flex-1 overflow-x-auto mt-4">
  <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">表名</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">描述</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">状态</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">版本</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">激活时间</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">信息</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">Xpert ID</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase">操作</th>
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      @for (table of tables(); track table.id) {
        <tr>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">{{ table.name }}</td>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ table.description || '-' }}</td>
          <td class="px-4 py-2 whitespace-nowrap text-sm">
            <span class="px-2 py-1 rounded-full text-xs font-semibold"
              [ngClass]="{
                'bg-green-100 text-green-800': table.status === eXpertTableStatus.ACTIVE,
                'bg-yellow-100 text-yellow-800': table.status === eXpertTableStatus.PENDING_ACTIVATION,
                'bg-red-100 text-red-800': table.status === eXpertTableStatus.DEPRECATED
              }">
              {{ table.status }}
            </span>
          </td>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ table.version || '-' }}</td>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ table.activatedAt ? (table.activatedAt | date:'yyyy-MM-dd HH:mm') : '-' }}</td>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ table.message }}</td>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ table.xpertId }}</td>
          <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
            <div class="flex gap-1">
              <button class="btn btn-ghost w-6 h-6 flex justify-center items-center rounded-lg" type="button"
                (click)="activate(table.id)">
                <i class="ri-magic-line"></i>
              </button>

              <button class="btn btn-ghost w-6 h-6 flex justify-center items-center rounded-lg" type="button"
                (click)="editTable(table)">
                <i class="ri-edit-line"></i>
              </button>
            </div>
          </td>
        </tr>
      }
    </tbody>
  </table>
</div>

@if (loading()) {
  <ngm-spin class="absolute left-0 top-0 w-full h-full flex justify-center items-center" />
}

@if (table()) {
  <div class="absolute right-1 top-1 bottom-1 w-96 lg:w-[500px] p-6 bg-neutral-50 rounded-2xl border border-solid border-gray-200 shadow-lg max-w-4xl mx-auto z-10">
    <div class="flex justify-between items-center">
      <h2 class="text-xl font-semibold mb-4">编辑表格</h2>
      <button type="button" class="flex justify-center items-center w-8 h-8 rounded-full hover:bg-gray-200 hover:text-text-destructive"
        (click)="table.set(null)">
        <i class="ri-close-line text-2xl"></i>
      </button>
    </div>

    <!-- 基本信息 -->
    <div class="space-y-4 bg-white p-4 rounded-lg border">
      <div>
        <label class="block text-sm font-medium mb-1">数据库 *</label>
        <div>
          <ngm-select [selectOptions]="databases$ | async" [(ngModel)]="database" [nullable]="false" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">模式 *</label>
        <div>
          <ngm-select [selectOptions]="schemasOptions()" [(ngModel)]="schema" [nullable]="false" />
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-1">数据表名称 *</label>
        <input
          type="text"
          class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-blue-300"
          [(ngModel)]="name"
        />
      </div>
      

      <div>
        <label class="block text-sm font-medium mb-1">数据表描述</label>
        <input
          type="text"
          class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-blue-300"
          [(ngModel)]="description"
        />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Table 查询模式</label>
        <select
          class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-blue-300"
        >
          <option>单用户模式</option>
          <option>多用户模式</option>
        </select>
      </div>
    </div>

    <!-- 字段定义 -->
    <div class="mt-6 bg-white p-4 rounded-lg border">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-md font-medium">存储字段定义</h3>
        <button
          (click)="addColumn()"
          class="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600"
        >
          + 新增
        </button>
      </div>

      <table class="w-full border-collapse text-sm">
        <thead>
          <tr class="bg-gray-100 text-gray-700">
            <th class="border p-2 text-left w-1/4">存储字段名称 *</th>
            <th class="border p-2 text-left w-1/4">描述</th>
            <th class="border p-2 text-left w-1/6">数据类型 *</th>
            <th class="border p-2 text-center w-1/6">是否必要</th>
            <th class="border p-2 text-center w-16">操作</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let col of table().columns; let i = index" class="border-b">
            <td class="p-2">
              <input
                type="text"
                class="w-full border rounded px-2 py-1 focus:ring focus:ring-blue-200"
                [(ngModel)]="col.name"
              />
            </td>
            <td class="p-2">
              <input
                type="text"
                class="w-full border rounded px-2 py-1 focus:ring focus:ring-blue-200"
                [(ngModel)]="col.label"
              />
            </td>
            <td class="p-2">
              <ngm-select [selectOptions]="types" [(ngModel)]="col.type" [nullable]="false" />
            </td>
            <td class="p-2 text-center">
              <input
                type="checkbox"
                class="h-4 w-4 text-blue-500"
                [(ngModel)]="col.required"
              />
            </td>
            <td class="p-2 text-center">
              <button
                (click)="removeColumn(i)"
                class="text-red-500 hover:text-red-700"
                title="删除"
              >
                ✕
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 保存按钮 -->
    <div class="mt-6 text-right">
      <button
        (click)="save()"
        class="btn btn-primary btn-large transition"
      >
        保存
      </button>
    </div>
  </div>
}

<ng-template #moreMenu>
  <div cdkMenu class="cdk-menu__large">
    <div cdkMenuItem >
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-text-tertiary mr-1" data-icon="FilePlus02" aria-hidden="true"><path d="M13.3333 6.99992V4.53325C13.3333 3.41315 13.3333 2.85309 13.1153 2.42527C12.9236 2.04895 12.6176 1.74299 12.2413 1.55124C11.8135 1.33325 11.2534 1.33325 10.1333 1.33325H5.86666C4.74655 1.33325 4.1865 1.33325 3.75868 1.55124C3.38235 1.74299 3.07639 2.04895 2.88464 2.42527C2.66666 2.85309 2.66666 3.41315 2.66666 4.53325V11.4666C2.66666 12.5867 2.66666 13.1467 2.88464 13.5746C3.07639 13.9509 3.38235 14.2569 3.75868 14.4486C4.1865 14.6666 4.74655 14.6666 5.86666 14.6666H7.99999M9.33332 7.33325H5.33332M6.66666 9.99992H5.33332M10.6667 4.66659H5.33332M12 13.9999V9.99992M9.99999 11.9999H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
      {{ 'PAC.Xpert.BulkImport' | translate: {Default: 'Bulk Import'} }}
    </div>

  </div>
</ng-template>