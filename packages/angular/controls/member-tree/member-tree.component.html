<div class="flex justify-start items-center gap-1">
  <button mat-icon-button [displayDensity]="appearance()?.displayDensity"
    (click)="$event.stopPropagation();toggleExpand()">
    @if (unfold) {
      <mat-icon>unfold_less</mat-icon>
    } @else {
      <mat-icon>unfold_more</mat-icon>
    }
  </button>
  @if (options()?.searchable ?? true) {
    <div class="relative flex-1">
      <i class="ri-search-2-line flex justify-center items-center absolute left-2 top-1/2 h-4 w-4 -translate-y-1/2 text-components-input-text-placeholder"></i>
      <input class="w-full appearance-none border border-transparent bg-components-input-bg-normal py-1.5 text-components-input-text-filled caret-primary-600 outline-none placeholder:text-components-input-text-placeholder hover:border-components-input-border-hover hover:bg-components-input-bg-hover focus:border-components-input-border-active focus:bg-components-input-bg-active focus:shadow-xs px-3 radius-md system-sm-regular pl-[26px]"
        [placeholder]="'Ngm.Controls.ValueHelp.Search' | translate: {Default: 'Search (supports multiple words and * wildcard, e.g. st*, *st, *st*)'}"
        [formControl]="searchControl"
      >
      @if (searchControl.value) {
        <i class="ri-close-circle-line cursor-pointer flex justify-center items-center absolute right-2 top-1/2 h-4 w-4 -translate-y-1/2 text-components-input-text-placeholder hover:text-text-primary"
          (click)="searchControl.setValue('')"></i>
      }
    </div>
  }
</div>

<cdk-virtual-scroll-viewport class="flex-1" [itemSize]="itemSize">
  <ng-container *cdkVirtualFor="let node of dataSource">
    <!-- Note that the [style.padding-left] is essentially what cdkTreeNodePadding is doing under the hood -->
    <div class="tree-node rounded-md" [style.padding-left]="node.level * treeNodePaddingIndent + 'px'" [displayDensity]="appearance()?.displayDensity">
      <!-- Note that treeControl.toggle(node) is essentially what cdkTreeNodeToggle is doing under the hood -->
      <button mat-icon-button disabled *ngIf="!node.expandable" [displayDensity]="appearance()?.displayDensity"></button>
      <button mat-icon-button *ngIf="node.expandable" [displayDensity]="appearance()?.displayDensity"
        (click)="treeControl.toggle(node)"
      >
        <mat-icon class="mat-icon-rtl-mirror">
          {{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
        </mat-icon>
      </button>

      <mat-checkbox
        [checked]="isSelected(node.raw)"
        [indeterminate]="isPartiallySelected(node)"
        (change)="itemSelectionToggle(node, $event)"
      >
        <ngm-display-behaviour [displayBehaviour]="displayBehaviour"
          [option]="{key: node.key, caption: node.caption}"
          [highlight]="highlightKeyword()"
        />
      </mat-checkbox>
    </div>
  </ng-container>
</cdk-virtual-scroll-viewport>

@if (loading$ | async) {
  <div class="absolute top-0 left-0 w-full h-full flex justify-center items-center">
    <mat-spinner strokeWidth="2" diameter="30"/>
  </div>
}

@if (error()) {
  <div class="ngm-card-error absolute left-0 top-0 w-full h-full overflow-auto 
    flex flex-col justify-center items-center"
  >
    <span class="text-2xl font-notoColorEmoji">üêû</span>
    <div class="whitespace-pre-wrap max-w-full text-red-500">
      {{ error() }}
    </div>
  </div>
}